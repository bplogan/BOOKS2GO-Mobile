<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">	
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>books2go</title>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="css/styles.css" />
	<script src="js/jquery-1.10.2.min.js"></script>
	<script src="js/jquery.mobile-1.4.3.min.js"></script>
	<script src="js/main.js"></script>
	<script src="phonegap.js"></script> 
	
	<script type="text/javascript" src="barcodescanner.js"></script>

	<script>

	
	
	
	function GetSchools(RID){
		$(".sub-item").hide();
	   	$.ajax({
	        type: "POST",
	        url: "http://www.books2go.ca/mobiservice/common.php?regionschools=1",
	        data: {'RID' : RID},
	        dataType: "json",
	        success: function(data) {
	        	
		        $("#r" + RID).html(data.result);
		        $("#r" + RID).show();
	     	},
	 	 	error: function(xhr, desc, err) {
	         alert(xhr);
	         alert("Details: " + desc + "\nError:" + err);
	       }
	   });         		
	}
	

	</script>
	<script id="panel-init">
		
	</script>
</head>

<body onload="init()">

<div id="launcherPage" data-role="page" >

	
	
	<div data-role="content" id="content">
		<div class='center' style="text-align:center">
			<p style="text-align: center"><img style='width:200px' src="images/logo3.png" alt="" /></p>
		
		<img src="images/ajax-loader.gif" />
			
		</div>
			
	
	</div>
			
			
	




<script>
var deviceToken;
function init() {
		
	document.addEventListener("deviceready", deviceReady, false);
	if (navigator.userAgent.match(/(iPad.*|iPhone.*|iPod.*);.*CPU.*OS 7_\d/i)) {
		$("body").addClass("ios7");
		$("body").append('');
	}
	


	
	
	
}
	
function deviceReady() {
	
	
	console.log("deviceReady");
	
	
	var plat = device.platform;	
	if(plat == "Android"){
		initPushwoosh_android();
	}else if(plat == "iPhone" || plat == "iOS"){
		initPushwoosh_iOS();
	}

	
	
	
	
	
	StatusBar.overlaysWebView(false);
	
	
	
	
		
	
			
			if(window.localStorage.getItem("user_id") !== undefined && window.localStorage.getItem("user_id") !== null){
		
				
				var UID = window.localStorage.getItem("user_id");
				$.ajax({
			        type: "POST",
			        url: "http://www.books2go.ca/mobiservice/notification.php?reg=1",
			        data: {'UUID' : deviceToken, 'UID' : UID},
			        dataType: "json",
			        success: function(data) {
			        	
			        	if(window.localStorage.getItem("PUSHURL") == undefined || window.localStorage.getItem("PUSHURL") == null){
			        		window.location = "profile.html"; 
			        	}else{
			        		var pushurl = window.localStorage.getItem("PUSHURL");
			        		window.localStorage.setItem("PUSHURL", null);
			        		alert("pushurl: " + pushurl);
			        		window.location = pushurl;       
			        		      
			        	}
			    		 
			     	},
			 	 	error: function(xhr, desc, err) {
			         alert(xhr);
			         alert("Details: " + desc + "\nError:" + err);
			       }
			   });         		
			
			}else{
				window.location = "main.html";
			}
		
	
}

function GoSearch(RID,SID){
	window.localStorage.setItem("search-text","");
	window.localStorage.setItem("search-region",RID);
	window.localStorage.setItem("search-school",SID);
	window.localStorage.setItem("search-data","");
	window.location = "search.html";
}


	





function initPushwoosh_iOS() {
    var pushNotification = cordova.require("com.pushwoosh.plugins.pushwoosh.PushNotification");
 
    //set push notification callback before we initialize the plugin
    document.addEventListener('push-notification', function(event) {
                                //get the notification payload
                                var notification = event.notification;
                                var data = event.notification.userdata;
                                window.localStorage["BID"] = data.bookid;
                                window.localStorage.setItem("PUSHURL",data.pushurl);
                              
                                //display alert to the user for example
                                //alert(notification.aps.alert + " in our face");
                                
                               
                                //clear the app badge
                                pushNotification.setApplicationIconBadgeNumber(0);
                            });
 
    //initialize the plugin
    pushNotification.onDeviceReady({pw_appid:"49CAB-F6ECD"});
     
    //register for pushes
    pushNotification.registerDevice(
        function(status) {
             deviceToken = status['deviceToken'];
           
            
            
            console.warn('registerDevice: ' + deviceToken);
        },
        function(status) {
            console.warn('failed to register : ' + JSON.stringify(status));
            alert(JSON.stringify(['failed to register ', status]));
        }
    );
     
    //reset badges on app start
    pushNotification.setApplicationIconBadgeNumber(0);
}

function initPushwoosh_android(){
	

    var pushNotification = cordova.require("com.pushwoosh.plugins.pushwoosh.PushNotification");
 
    //set push notifications handler
    document.addEventListener('push-notification', function(event) {
        var title = event.notification.title;
        var userData = event.notification.userdata;
                                 
        if(typeof(userData) != "undefined") {
        	window.localStorage["BID"] = userdata.bookid;
            window.localStorage.setItem("PUSHURL",userdata.pushurl);
            console.warn('user data: ' + JSON.stringify(userData));
            
           
            
        }
                                     
       
    });
 
    //initialize Pushwoosh with projectid: "GOOGLE_PROJECT_ID", pw_appid : "PUSHWOOSH_APP_ID". This will trigger all pending push notifications on start.
    pushNotification.onDeviceReady({ projectid: "books2go-app", pw_appid : "49CAB-F6ECD" });
 
    //register for pushes
    pushNotification.registerDevice(
        function(status) {
            var pushToken = status;
            console.warn('push token: ' + pushToken);
        },
        function(status) {
            console.warn(JSON.stringify(['failed to register ', status]));
        }
    );
}

		
		


</script>

</div><!-- /page -->



</body>
</html>
