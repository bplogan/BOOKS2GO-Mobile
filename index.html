<html>
<head>
	<meta name="viewport" content="width=device-width, initial-scale=1">	
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
	<title>books2go</title>
	<link rel="stylesheet" href="http://code.jquery.com/mobile/1.4.5/jquery.mobile-1.4.5.min.css" />
	<link rel="stylesheet" href="css/styles.css" />
	<script src="js/jquery-1.10.2.min.js"></script>
	<script src="js/jquery.mobile-1.4.3.min.js"></script>
	<script src="js/main.js"></script>
	<script src="phonegap.js"></script> 
	
	<script type="text/javascript" src="barcodescanner.js"></script>

	<script>

	
	
	
	function GetSchools(RID){
		$(".sub-item").hide();
	   	$.ajax({
	        type: "POST",
	        url: "http://www.books2go.ca/mobiservice/common.php?regionschools=1",
	        data: {'RID' : RID},
	        dataType: "json",
	        success: function(data) {
	        	
		        $("#r" + RID).html(data.result);
		        $("#r" + RID).show();
	     	},
	 	 	error: function(xhr, desc, err) {
	         alert(xhr);
	         alert("Details: " + desc + "\nError:" + err);
	       }
	   });         		
	}
	

	</script>
	<script id="panel-init">
		
	</script>
</head>

<body onload="init()">

<div id="launcherPage" data-role="page" >

	
	
	<div data-role="content" id="content">
		<div class='center' style="text-align:center">
			<p style="text-align: center"><img style='width:200px' src="images/logo3.png" alt="" /></p>
		
		<img src="images/ajax-loader.gif" />
			
		</div>
			
	
	</div>
			
			
	




<script>

function init() {
		
	document.addEventListener("deviceready", deviceReady, false);
	if (navigator.userAgent.match(/(iPad.*|iPhone.*|iPod.*);.*CPU.*OS 7_\d/i)) {
		$("body").addClass("ios7");
		$("body").append('');
	}
	


	
	
	
}

function SetToken(uuid,uid){
	
	alert("Set Token: " + uuid + "," + uid);
	
	if(uid > 0){
		$.ajax({
	        type: "POST",
	        url: "http://www.books2go.ca/mobiservice/notification.php?reg=1",
	        async: false,
	        data: {'UUID' : uuid, 'UID' : uid},
	        dataType: "json",
	        success: function(data) {
	        	window.location = "profile.html";	 
	     	},
	 	 	error: function(xhr, desc, err) {
	         alert(xhr);
	         alert("Details: " + desc + "\nError:" + err);
	       }
	   	});         		
	}else{
		window.location = "main.html";
	}		
		
}

	
function deviceReady() {
		
	console.log("deviceReady");
	StatusBar.overlaysWebView(false);
	
		
	var plat = device.platform;	
	if(plat == "iPhone" || plat == "iOS"){
		alert("registering ios");
		initPushwoosh_iOS();
	}else{
		alert("register android");
		initPushwoosh_android();
	}
			
	
}

function GoSearch(RID,SID){
	window.localStorage.setItem("search-text","");
	window.localStorage.setItem("search-region",RID);
	window.localStorage.setItem("search-school",SID);
	window.localStorage.setItem("search-data","");
	window.location = "search.html";
}


	





function initPushwoosh_iOS() {
    var pushNotification = cordova.require("com.pushwoosh.plugins.pushwoosh.PushNotification");
 	var uid = window.localStorage.getItem("user_id"); 
    //set push notification callback before we initialize the plugin
    document.addEventListener('push-notification', function(event) {
        //get the notification payload
        var notification = event.notification;
        var data = event.notification.userdata;
        window.localStorage["BID"] = data.bookid;
        window.localStorage.setItem("PUSHURL",data.pushurl);
       
       	window.location = data.pushurl;
       
        
       
        //clear the app badge
        pushNotification.setApplicationIconBadgeNumber(0);
    });
 
    //initialize the plugin
    pushNotification.onDeviceReady({pw_appid:"49CAB-F6ECD"});
     
    //register for pushes
    pushNotification.registerDevice(
        function(status) {
            var deviceToken = status['deviceToken'];
           	SetToken(deviceToken,uid);
         	console.warn('registerDevice: ' + deviceToken);
        },
        function(status) {
            console.warn('failed to register : ' + JSON.stringify(status));
            alert(JSON.stringify(['failed to register ', status]));
        }
    );
     
    //reset badges on app start
    pushNotification.setApplicationIconBadgeNumber(0);
}

function initPushwoosh_android(){
	var uid = window.localStorage.getItem("user_id"); 
	var pushNotification = cordova.require("com.pushwoosh.plugins.pushwoosh.PushNotification");
    document.addEventListener('push-notification', function(event) {
        var title = event.notification.title;
        var userData = event.notification.userdata;
                                
        if(typeof(userData) != "undefined") {
        	window.localStorage["BID"] = userData.bookid;
            window.localStorage.setItem("PUSHURL",userData.pushurl);
           	window.location = userData.pushurl;
            console.warn('user data: ' + JSON.stringify(userData));
         }
    });
 
	pushNotification.onDeviceReady({ projectid: "758601829939", pw_appid : "49CAB-F6ECD" });
    pushNotification.registerDevice(
        function(status) {
            var deviceToken = status;
            SetToken(deviceToken,uid);
           
            console.warn('push token: ' + deviceToken);
        },
        function(status) {
            console.warn(JSON.stringify(['failed to register ', status]));
        }
    );
}

		
		


</script>

</div><!-- /page -->



</body>
</html>
